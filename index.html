<html>
	<head>
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
		<title>Stars</title>
		<link href='http://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
		<style>
			html, body {
				margin: 0;
				padding: 0;
			}
			body {
				font-family: 'Montserrat', sans-serif;
				font-size: 22px;
			}
			canvas {
				position: absolute;
				left: 0;
				top: 0;
			}
		</style>
	</head>
	<body>
		<canvas id="field">No canvas support</canvas>
		<canvas id="static"></canvas>
		<script>
			// ==set-up==
			// =settings=
			var ANIMATION_FRAME = true;
			var SPEED = 1; // only used if ANIMATION_FRAME == false
			var PAUSED = false;
			var DEBUG = true;
			var MODE = 0;
			var NUM_SICK = 1;
			var NUM_HEALTHY = 100;
			var PIXES_PER_CELL = 10;
			// =template methods=
			var noop = function (){};

			// =canvas=
			var canvas = document.getElementById('field');
			canvas.width = document.body.clientWidth;
			canvas.height = document.body.clientHeight;
			var ctx = canvas.getContext('2d');
			
			var staticCanvas = document.getElementById('static');
			staticCanvas.width = canvas.width;
			staticCanvas.height = canvas.height;
			var staticCtx = staticCanvas.getContext('2d');
			staticCtx.font = "8pt Arial";
			staticCtx.textAlign = "end";
			
			var model = {
				width: Math.round(canvas.width / PIXES_PER_CELL),
				height: Math.round(canvas.height / PIXES_PER_CELL),
				all: [],
				sick: [],
				healthy: [],
				obstacles: [],
			};
			// ==populate==
			for (var i=0; i<NUM_SICK; i++) {
				var s = randomPos();
				s.type = 'sick';
				model.sick.push(s);
				model.all.push(s);
			}
			for (var i=0; i<NUM_HEALTHY; i++) {
				var h = randomPos();
				h.type = 'healthy';
				model.healthy.push(h);
				model.all.push(h);
			}

			// ==callback==
			function tick() {
				if (!PAUSED) {
					move();
					ctx.clearRect(0, 0, canvas.width, canvas.height);
					draw(model.all);
				}
				if (DEBUG) {
					drawFramerate();
					drawFps();
				}
				if (ANIMATION_FRAME) {
					requestAnimationFrame(tick);
				}
			}
			requestAnimationFrame(tick);

			// ==movement==
			function move() {
				var i, posMap = {}, posHash, sick, healthy;
				for (i in model.sick) {
					sick = model.sick[i];
					moveRandom(sick);
					wrap(sick);
					posHash = getPosHash(sick);
					if (posMap[posHash]) { //collision
						sick.x = sick.oldX;
						sick.y = sick.oldY;
					} else {
						posMap[posHash] = sick;
					}
				}
				for (i in model.healthy) {
					healthy = model.healthy[i];
					moveRandom(healthy);
					wrap(healthy);
					posHash = getPosHash(healthy);
					if (posMap[posHash]) { //collision
						healthy.x = healthy.oldX;
						healthy.y = healthy.oldY;
						
					} else {
						posMap[posHash] = healthy[i];
					}
				}
			}
			function moveRandom(actor) {
				var entropy = Math.random();
				actor.oldX = actor.x;
				actor.oldY = actor.y;
				if (entropy > .5) {
					actor.x++;
				} else {
					actor.x--;
				}
				if (entropy % 0.1 > .05) {
					actor.y++;
				} else {
					actor.y--;
				}
			}
			function wrap(actor) {
				if (actor.x < 0) {
					actor.x = model.width;
				}
				if (actor.x > model.width) {
					actor.x = 0;
				}
				if (actor.y < 0) {
					actor.y = model.height;
				}
				if (actor.y > model.height) {
					actor.y = 0;
				}
			}
			// =fps=
			var drawFps = (function () {
				var fps = 0;
				var frameCount = 0;
				setInterval(function () {
					fps = frameCount;
					frameCount = 0;
				}, 1000); //1 second
				return function () {
					frameCount++;
					ctx.fillStyle = "#000000";
					ctx.fillText(fps+" fps", canvas.width-30, 20);
				}
			})();
			
			// =framerate=
			var drawFramerate = (function () {
				var lastFrame = new Date().getTime();
				return function () {
					var thisFrame = new Date().getTime();
					ctx.fillStyle = "#000000";
					ctx.fillText((thisFrame - lastFrame) / 1000, canvas.width-30, 10);
					lastFrame = thisFrame;
				}
			})();
			
			// ==draw==
			function draw(actors) {
				var actor, i;
				for (i in actors) {
					actor = actors[i];
					switch(actor.type) {
						case 'sick':
							ctx.fillStyle = '#33cc33';
						break;
						case 'healthy':
							ctx.fillStyle = '#777777';
						break;
					}
					ctx.fillRect(actor.x * PIXES_PER_CELL, actor.y * PIXES_PER_CELL, PIXES_PER_CELL, PIXES_PER_CELL);
				}
			}
			function randomPos() {
				return {
					x: Math.floor(Math.random() * model.width),
					y: Math.floor(Math.random() * model.height)
				};
			}
			function getPosHash(actor) {
				return actor.x * model.width + actor.y;
			}
		</script>
	</body>
</html>
